---
# tasks file for promtail uninstall
- name: Stop Promtail service
  ansible.builtin.systemd:  # noqa ignore-errors
    name: promtail
    state: stopped
  ignore_errors: true

- name: Extract log files from static_configs - labels - path
  ansible.builtin.set_fact:
    __promtail_acl_log_files: >-
      {{
        promtail_scrape_configs
        | selectattr('static_configs', 'defined')
        | map(attribute='static_configs')
        | flatten
        | map(attribute='labels')
        | map(attribute='__path__')
        | list
      }}

- name: Extract log dirs paths from static_configs - labels - path
  ansible.builtin.set_fact:
    __promtail_acl_log_dirs: >-
      {{
        promtail_scrape_configs
        | selectattr('static_configs', 'defined')
        | map(attribute='static_configs')
        | flatten
        | map(attribute='labels')
        | map(attribute='__path__')
        | map('dirname')
        | list
      }}

- name: Remove ACL Permission for log dir
  ansible.posix.acl:  # noqa ignore-errors
    path: "{{ log_dir }}"
    recursive: true
    entity: promtail
    etype: user
    default: true
    state: absent
  loop: "{{ __promtail_acl_log_dirs }}"
  loop_control:
    loop_var: log_dir
  ignore_errors: true

- name: Remove ACL Permission for existing log files
  ansible.posix.acl:  # noqa ignore-errors
    path: "{{ log_files }}"
    entity: promtail
    etype: user
    state: absent
  loop: "{{ __promtail_acl_log_files }}"
  loop_control:
    loop_var: log_files
  ignore_errors: true

- name: Uninstall Promtail rpm package
  ansible.builtin.dnf:
    name: "promtail"
    state: absent
    autoremove: true

- name: Ensure that Promtail firewalld rule is not present - tcp port {{ promtail_http_listen_port }}
  ansible.posix.firewalld:  # noqa ignore-errors
    immediate: true
    permanent: true
    port: "{{ promtail_http_listen_port }}/tcp"
    state: disabled
  ignore_errors: true

- name: Remove Promtail directories"
  ansible.builtin.file:
    path: "{{ remove_me }}"
    state: absent
  loop:
    - "/etc/promtail"
    - "{{ promtail_positions_path }}"
    - "/etc/logrotate.d/promtail_acl"
    - "/var/log/dummy_promtail_acl"
  loop_control:
    loop_var: remove_me

- name: Remove the Promtail system user
  ansible.builtin.user:
    name: "promtail"
    force: true
    state: absent

- name: Remove Promtail system group
  ansible.builtin.group:
    name: "promtail"
    state: absent
